# QEMU Section Readme

this folder is for stuff needed to emulate the device

## Folder Structure
### Scripts
- `run_qemu.sh` starts a qemu vm (can use `-initrd` flag to use intird image. Otherwise needs image generated by `create_rootfs_image.sh`)
- `run_qemu_usermode.sh` can run individual binaries emulating the XBurstR2 CPU
- `create_rootfs_image.sh` (requires sudo) bundles squashfs-root into an ext4 image for use with `run_qemu.sh`

### Other Files
- `initrd.cpio`: This is the initrd image for `run_qemu_initrd.sh`
- `rootfs-image`: This is the rootfs image for `run_qemu.sh`

## Current Debug Method
In order to get the kernel output from qemu youll need to use `gdb` (the GNU Debug Tool).
The outputs from this debugging have been put into the logs directory for analysis after being cleaned (there were a lot of useless lines).

*Note: If later steps inside gdb (such as `target remote :1234`) are failing, ensure you have the mips-specific packages in the project README and load with `gdb-multiarch Linux-4.4.94+.elf` instead.*

1. Run `run_qemu.sh` to start the vm.
2. Run `gdb Linux-4.4.94+.elf` (you might need to change the path to the elf depending on your current directory). This opens up the gdb tool analyzing the kernel.
3. Now that you're in the gdb tool, run `target remote :1234`.
4. Run `continue`. Wait for a pretty long while (like 10-30 seconds in my testing).
5. After a while, kill the continue (by pressing `ctrl`+`c`).
    - At some point, qemu's panic triggered the continue to end automatically. But the current setup requires it to be stopped manually.
6. Run `x/2000s __log_buf`, then type "c" and press enter to let it print out the whole log. This should show the kernel log, and end with a traceback from a panic. If it just ends at `random: nonblocking pool is initialized"`, then you probably didnt let it continue long enough.
7. Save that log, it's useful. You'll probably want to get rid of all the empty lines though.
8. Run `bt` to get a simple backtrace. I've not found it useful yet, but more info is more info.
